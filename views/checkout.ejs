<%- include('partials/header') %>

<main class="main-content">
    <div class="container">
        <h1 class="page-title">Checkout</h1>
        
        <div class="checkout-content">
            <div class="checkout-form">
                <div class="checkout-section">
                    <h3>Shipping Information</h3>
                    
                    <form id="checkoutForm">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="fullName" value="<%= user.first_name %> <%= user.last_name %>" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email" value="<%= user.email %>" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="phone" value="<%= user.phone || '' %>" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Shipping Address</label>
                            <textarea id="shippingAddress" rows="3" required><%= user.address || '' %></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="checkout-section">
                    <h3>Payment Method</h3>
                    <div class="payment-info">
                        <i class="fas fa-credit-card"></i>
                        <p>Pay securely with Paystack</p>
                    </div>
                </div>
            </div>
            
            <div class="checkout-summary">
                <h3>Order Summary</h3>
                
                <div class="summary-items">
                    <% cart.items.forEach(item => { %>
                        <div class="summary-item">
                            <div>
                                <strong><%= item.productName %></strong>
                                <p>Qty: <%= item.quantity %></p>
                            </div>
                            <span>₦<%= Number(item.price * item.quantity).toLocaleString() %></span>
                        </div>
                    <% }) %>
                </div>
                
                <hr>
                
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span>₦<%= Number(cart.totalPrice).toLocaleString() %></span>
                </div>
                
                <div class="summary-row">
                    <span>Delivery:</span>
                    <span>₦2,000</span>
                </div>
                
                <hr>
                
                <div class="summary-row summary-total">
                    <strong>Total:</strong>
                    <strong id="totalAmount">₦<%= Number(cart.totalPrice + 2000).toLocaleString() %></strong>
                </div>
                
                <button onclick="payWithPaystack()" class="btn btn-primary btn-block">
                    <i class="fas fa-lock"></i> Pay Now
                </button>
            </div>
        </div>
    </div>
</main>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
    const paystackPublicKey = '<%= paystackPublicKey %>';
    const totalAmount = <%= cart.totalPrice + 2000 %>;
    const userEmail = '<%= user.email %>';
    
    function payWithPaystack() {
        const shippingAddress = document.getElementById('shippingAddress').value;
        const phone = document.getElementById('phone').value;
        
        if (!shippingAddress || !phone) {
            alert('Please fill in all required fields');
            return;
        }
        
        const handler = PaystackPop.setup({
            key: paystackPublicKey,
            email: userEmail,
            amount: totalAmount * 100, // Amount in kobo
            currency: 'NGN',
            ref: 'HS' + Math.floor((Math.random() * 1000000000) + 1),
            callback: function(response) {
                verifyPayment(response.reference, shippingAddress);
            },
            onClose: function() {
                alert('Payment cancelled');
            }
        });
        
        handler.openIframe();
    }
    
    async function verifyPayment(reference, shippingAddress) {
        try {
            // Verify payment
            const verifyResponse = await fetch('/orders/verify-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reference })
            });
            
            const verifyData = await verifyResponse.json();
            
            if (verifyData.success) {
                // Create order
                const orderResponse = await fetch('/orders/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shippingAddress,
                        paymentReference: reference
                    })
                });
                
                const orderData = await orderResponse.json();
                
                if (orderData.success) {
                    alert('Order placed successfully!');
                    window.location.href = '/orders';
                } else {
                    alert('Error creating order. Please contact support.');
                }
            } else {
                alert('Payment verification failed');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred. Please contact support.');
        }
    }
</script>

<%- include('partials/footer') %>